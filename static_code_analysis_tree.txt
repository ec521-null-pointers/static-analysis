STATIC CODE ANALYSIS INVESTIGATION TREE
---------------------------------------

1. Lifecycle / Postinstall Triggers
|--- Detect lifecycle scripts in package.json
|    |--- preinstall / install / postinstall / prepare
|    |--- Check command string for "node", "bash", "curl", etc.
|
|--- Resolve target of command
|    |--- Local JS file (e.g. node bundle.js) → inspect the file
|    |--- Shell pipeline (e.g. curl | sh) → immediately high risk
|    |--- External fetch to URL → check domains
|
|--- Inspect target file content
|    |--- Look for eval / new Function / child_process
|    |--- Search for fetch / https / network calls
|    |--- Search for process.env or credential access
|    |--- Compute file size, entropy, and encoded blobs
|
|--- Classify result
|    |--- Safe: known build tool (node-gyp, tsc, prebuild-install)
|    |--- Suspicious: local JS with obfuscation or unknown logic
|    |--- High-risk: executes shell, network fetch, or child_process
|
|--- Next step
|    |--- Run Semgrep on target file
|    |--- Extract base64 blobs for offline decode
|    |--- Generate JSON summary and severity score

2. Obfuscation / Decode Chains
|--- Detect decoding primitives
|    |--- atob(), Buffer.from(...,'base64'), base64 -d, unescape(), decodeURIComponent()
|
|--- Find encoded data
|    |--- grep for long base64-like strings
|    |--- Measure entropy (entropy > 4.5 = likely encoded payload)
|
|--- Identify decode-depth
|    |--- Trace sequence: decode → transform → eval/new Function
|    |--- Multi-level decoding = high-risk
|
|--- Extract candidate blobs
|    |--- Decode only in isolated sandbox
|    |--- Inspect decoded content for JS, binaries, or URLs

3. Dangerous Execution / System Interaction
|--- Child process usage
|    |--- require('child_process'), exec(), spawn(), execFile()
|
|--- Dynamic code execution
|    |--- eval(), new Function(), vm.runInNewContext(), setTimeout(string,...)
|
|--- Dynamic require or import
|    |--- require(variable), import(variable)
|
|--- Environment or platform gating
|    |--- process.env, process.platform, Math.random(), Date.now()
|
|--- Assess severity
|    |--- Presence of exec/eval = high-risk
|    |--- Gated execution (checks for CI/user) = targeted attack

4. Network Activity / Exfiltration
|--- Detect network calls
|    |--- fetch(), axios(), request(), XMLHttpRequest, https.request()
|
|--- Extract domains and endpoints
|    |--- grep for "http://" or "https://" strings
|    |--- Identify suspicious TLDs (.xyz, .top, raw IP)
|
|--- Detect environment or credential access
|    |--- process.env, fs.readFileSync('.npmrc'), .ssh, tokens
|
|--- Identify webhook or CI interactions
|    |--- Strings: webhook, GITHUB_TOKEN, api.github.com, gitlab
|
|--- Assess
|    |--- Remote POST or credential exfil = high-risk
|    |--- Local telemetry or harmless API = low-risk

5. Provenance / Metadata Signals
|--- Review package.json metadata
|    |--- name, version, author, repository, license
|
|--- Check for typosquatting
|    |--- Compare name similarity with popular packages
|
|--- Verify maintainer and email domain
|    |--- Disposable or unclaimed domains → suspicious
|
|--- Compare repository vs tarball
|    |--- Files missing or extra binaries → mismatch
|
|--- Evaluate release pattern
|    |--- Sudden version jumps or new maintainer → potential compromise

6. Cross-File & Dependency Linking
|--- Trace require/import statements
|    |--- require('./lib/...'), dynamic requires
|
|--- Inspect additional files referenced by bundle.js
|    |--- Apply same Semgrep + grep checks
|
|--- Look for bundled/minified sources
|    |--- //# sourceMappingURL= → retrieve original code
|
|--- Inspect dependency definitions
|    |--- dependencies with URLs or tarballs → non-immutable
|
|--- Severity
|    |--- External require or remote dependency load = high-risk

7. Hidden Payloads / Steganography / Artifacts
|--- Search for embedded image or binary data
|    |--- data:image/png;base64,...
|
|--- Detect steganographic behavior
|    |--- getImageData, canvas, pixel loops, image decoding libs
|
|--- Search comments or ASCII art
|    |--- URLs, tokens, or instructions hidden in comments

8. Scoring & Explainability
|--- Assign weights
|    |--- postinstall: +3
|    |--- eval/new Function: +4
|    |--- child_process: +5
|    |--- network exfil: +4
|    |--- high entropy blob: +2
|    |--- typosquat/metadata anomaly: +3
|
|--- Compute composite score
|    |--- 0–3 = Safe
|    |--- 4–7 = Suspicious
|    |--- 8+ = High-Risk
|
|--- Produce explainable output
|    |--- trigger → evidence → reasoning → score → action
|
|--- Integrate into CI
|    |--- Run Semgrep + GuardDog + classifier → merge results → flag high-risk packages

